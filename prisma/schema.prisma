generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ══════════════════════════════════
// MULTI-TENANT CORE
// ══════════════════════════════════

model Organization {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  logo      String?
  plan      Plan     @default(FREE)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  sites     Site[]
  users     UserOnOrganization[]
  auditLogs AuditLog[]
  invites   Invite[]
}

model Site {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  name           String
  slug           String
  domain         String?
  gaId           String?
  language       String       @default("bs")
  timezone       String       @default("Europe/Sarajevo")
  theme          String       @default("editorial")
  wpSiteUrl      String?
  wpApiKey       String?
  competitorFeeds String[]    @default([])
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  deletedAt      DateTime?

  articles          Article[]
  widgets           Widget[]
  categories        Category[]
  socialConnections SocialConnection[]
  media             Media[]
  subscribers       Subscriber[]

  @@unique([organizationId, slug])
  @@index([organizationId])
}

model SocialConnection {
  id           String   @id @default(cuid())
  siteId       String
  site         Site     @relation(fields: [siteId], references: [id], onDelete: Cascade)
  provider     String
  accessToken  String
  refreshToken String?
  expiresAt    DateTime?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  pages SocialPage[]

  @@unique([siteId, provider])
}

model SocialPage {
  id           String           @id @default(cuid())
  connectionId String
  connection   SocialConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  pageId       String
  pageName     String
  pageToken    String
  isActive     Boolean          @default(true)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  @@unique([connectionId, pageId])
}

// ══════════════════════════════════
// AUTH & USERS
// ══════════════════════════════════

model User {
  id                  String    @id @default(cuid())
  email               String    @unique
  name                String?
  passwordHash        String?
  image               String?
  emailVerified       DateTime?
  onboardingCompleted Boolean   @default(false)
  createdAt           DateTime  @default(now())

  accounts Account[]
  sessions Session[]
  orgs     UserOnOrganization[]
}

model UserOnOrganization {
  id             String       @id @default(cuid())
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  role           OrgRole      @default(JOURNALIST)
  permissions    String[]
  joinedAt       DateTime     @default(now())
  deletedAt      DateTime?

  @@unique([userId, organizationId])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expires      DateTime
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ══════════════════════════════════
// CONTENT
// ══════════════════════════════════

model Article {
  id        String        @id @default(cuid())
  siteId    String
  site      Site          @relation(fields: [siteId], references: [id], onDelete: Cascade)
  title     String
  slug      String
  content   Json
  excerpt   String?
  status    ArticleStatus @default(DRAFT)
  authorId  String?

  isTest       Boolean  @default(false)
  aiGenerated  Boolean  @default(false)
  aiModel      String?
  aiPrompt     String?
  aiRevisions  AIRevision[]
  versions     ArticleVersion[]
  tags         ArticleTag[]

  publishedAt  DateTime?
  scheduledAt  DateTime?

  featuredImage      String?
  metaTitle          String?
  metaDescription    String?
  distributionStatus Json?

  categoryId String?
  category   Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  @@unique([siteId, slug])
  @@index([siteId, status])
  @@index([siteId, publishedAt])
  @@index([siteId])
}

model AIRevision {
  id        String  @id @default(cuid())
  articleId String
  article   Article @relation(fields: [articleId], references: [id], onDelete: Cascade)
  version   Int
  content   Json
  prompt    String
  model     String
  tokensIn  Int?
  tokensOut Int?
  createdAt DateTime @default(now())
}

model Category {
  id        String    @id @default(cuid())
  siteId    String
  site      Site      @relation(fields: [siteId], references: [id], onDelete: Cascade)
  name      String
  slug      String
  icon      String?
  order     Int       @default(0)
  deletedAt DateTime?

  articles Article[]

  @@unique([siteId, slug])
}

model Widget {
  id        String     @id @default(cuid())
  siteId    String
  site      Site       @relation(fields: [siteId], references: [id], onDelete: Cascade)
  name      String
  type      WidgetType
  config    Json
  active    Boolean    @default(true)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  deletedAt DateTime?

  analyticsEvents AnalyticsEvent[]
}

model Media {
  id         String   @id @default(cuid())
  siteId     String
  site       Site     @relation(fields: [siteId], references: [id], onDelete: Cascade)
  filename   String
  url        String
  alt        String?
  width      Int?
  height     Int?
  size       Int
  mimeType   String
  uploadedBy String?
  createdAt  DateTime @default(now())

  @@index([siteId, createdAt])
}

model Subscriber {
  id             String    @id @default(cuid())
  siteId         String
  site           Site      @relation(fields: [siteId], references: [id], onDelete: Cascade)
  email          String
  name           String?
  isActive       Boolean   @default(true)
  subscribedAt   DateTime  @default(now())
  unsubscribedAt DateTime?

  @@unique([siteId, email])
  @@index([siteId, isActive])
}

model ArticleVersion {
  id        String   @id @default(cuid())
  articleId String
  article   Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)
  title     String
  content   Json
  savedBy   String?
  version   Int
  createdAt DateTime @default(now())

  @@index([articleId, version])
}

model Tag {
  id        String       @id @default(cuid())
  siteId    String
  name      String
  slug      String
  createdAt DateTime     @default(now())

  articles  ArticleTag[]

  @@unique([siteId, slug])
  @@index([siteId])
}

model ArticleTag {
  id        String  @id @default(cuid())
  articleId String
  article   Article @relation(fields: [articleId], references: [id], onDelete: Cascade)
  tagId     String
  tag       Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([articleId, tagId])
}

model AnalyticsEvent {
  id        String   @id @default(cuid())
  widgetId  String?
  widget    Widget?  @relation(fields: [widgetId], references: [id], onDelete: SetNull)
  eventType String
  metadata  Json?
  country   String?
  device    String?
  createdAt DateTime @default(now())

  @@index([widgetId, eventType])
  @@index([createdAt])
}

// ══════════════════════════════════
// INVITES
// ══════════════════════════════════

model Invite {
  id             String       @id @default(cuid())
  email          String
  role           OrgRole      @default(JOURNALIST)
  token          String       @unique
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  invitedById    String
  usedAt         DateTime?
  createdAt      DateTime     @default(now())
  expiresAt      DateTime

  @@index([organizationId])
  @@index([token])
}

// ══════════════════════════════════
// AUDIT LOG
// ══════════════════════════════════

model AuditLog {
  id             String       @id @default(cuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String?
  action         String
  entityType     String
  entityId       String?
  meta           Json?
  createdAt      DateTime     @default(now())

  @@index([organizationId, createdAt])
  @@index([entityType, entityId])
}

// ══════════════════════════════════
// ENUMS
// ══════════════════════════════════

enum Plan {
  FREE
  STARTER
  PRO
  ENTERPRISE
}

enum OrgRole {
  OWNER
  ADMIN
  EDITOR
  JOURNALIST
}

enum ArticleStatus {
  DRAFT
  IN_REVIEW
  SCHEDULED
  PUBLISHED
  ARCHIVED
}

enum WidgetType {
  MATCH_WIDGET
  STANDINGS
  POLL
  QUIZ
  SURVEY
  LIVE_SCORE
  STATS_TABLE
}

// ══════════════════════════════════
// RSS FEED ENGINE
// ══════════════════════════════════

model NewsItem {
  id           String   @id @default(cuid())
  title        String
  source       String
  sourceDomain String
  sourceUrl    String
  contentHash  String?
  content      String?  @db.Text
  category     String   @default("breaking")
  eventType    String?
  pubDate      DateTime
  feedUrl      String
  tier         Int      @default(3)
  dis          Int      @default(0)
  clusterId    String?
  siteId       String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([sourceUrl])
  @@unique([contentHash])
  @@index([pubDate])
  @@index([category])
  @@index([siteId, pubDate])
  @@index([clusterId])
}

model FeedSource {
  id         String    @id @default(cuid())
  name       String
  url        String    @unique
  category   String    @default("breaking")
  tier       Int       @default(3)
  country    String    @default("global")
  active     Boolean   @default(true)
  lastFetch  DateTime?
  itemCount  Int       @default(0)
  errorCount Int       @default(0)
  siteId     String?
  createdAt  DateTime  @default(now())
}

model Entity {
  id        String   @id @default(cuid())
  name      String   @unique
  type      String
  aliases   String[]
  metadata  Json?
  createdAt DateTime @default(now())

  @@index([type])
}

model Player {
  id               String    @id @default(cuid())
  apiFootballId    Int?      @unique
  name             String
  shortName        String?
  firstName        String?
  lastName         String?
  nationality      String?
  nationalityFlag  String?
  dateOfBirth      DateTime?
  age              Int?
  height           String?
  weight           String?
  photo            String?
  position         String?
  detailedPosition String?
  preferredFoot    String?
  currentTeam      String?
  currentTeamId    Int?
  currentLeague    String?
  currentLeagueId  Int?
  jerseyNumber     Int?
  injured          Boolean   @default(false)

  salary           Int?
  salaryNet        Int?
  salaryAnnual     Int?
  contractExpiry   DateTime?
  contractStart    DateTime?
  marketValue      String?

  capologySlug     String?
  lastSyncedAt     DateTime?
  lastSalarySyncAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  seasons   PlayerSeason[]
  transfers Transfer[]
  injuries  Injury[]

  @@index([currentTeamId])
  @@index([currentLeagueId])
  @@index([nationality])
  @@index([position])
}

model PlayerSeason {
  id            String @id @default(cuid())
  playerId      String
  player        Player @relation(fields: [playerId], references: [id], onDelete: Cascade)
  season        Int
  leagueId      Int?
  leagueName    String?
  teamId        Int?
  teamName      String?

  appearances   Int    @default(0)
  lineups       Int    @default(0)
  minutes       Int    @default(0)

  goals         Int    @default(0)
  assists       Int    @default(0)
  shots         Int    @default(0)
  shotsOnTarget Int    @default(0)

  totalPasses   Int    @default(0)
  keyPasses     Int    @default(0)
  passAccuracy  Float?

  tackles       Int    @default(0)
  blocks        Int    @default(0)
  interceptions Int    @default(0)

  dribbleAttempts Int  @default(0)
  dribbleSuccess  Int  @default(0)

  yellowCards    Int   @default(0)
  redCards       Int   @default(0)
  foulsCommitted Int   @default(0)
  foulsDrawn     Int   @default(0)

  saves          Int?
  goalsConceded  Int?
  cleanSheets    Int?
  penaltySaved   Int?

  rating Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([playerId, season, leagueId])
  @@index([season])
  @@index([leagueId])
}

model Transfer {
  id         String    @id @default(cuid())
  playerId   String
  player     Player    @relation(fields: [playerId], references: [id], onDelete: Cascade)
  date       DateTime?
  fromTeam   String?
  fromTeamId Int?
  toTeam     String?
  toTeamId   Int?
  type       String?
  fee        String?

  createdAt DateTime @default(now())

  @@index([playerId])
}

model Injury {
  id        String    @id @default(cuid())
  playerId  String
  player    Player    @relation(fields: [playerId], references: [id], onDelete: Cascade)
  type      String?
  reason    String?
  startDate DateTime?
  endDate   DateTime?

  createdAt DateTime @default(now())

  @@index([playerId])
}

model ClubFinancials {
  id            String  @id @default(cuid())
  teamName      String
  teamId        Int?
  leagueName    String?
  season        Int

  totalPayroll  Int?
  highestPaid   String?
  highestSalary Int?
  averageSalary Int?
  squadSize     Int?

  revenue           Int?
  matchdayRevenue   Int?
  broadcastRevenue  Int?
  commercialRevenue Int?
  totalCosts        Int?
  profit            Int?

  capologySlug String?
  lastSyncedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([teamName, season])
  @@index([leagueName])
  @@index([season])
}

model StoryCluster {
  id              String   @id @default(cuid())
  key             String   @unique
  title           String
  eventType       String
  primaryEntity   String
  primaryEntityType String
  entities        String[]
  sourceCount     Int      @default(0)
  tier1Count      Int      @default(0)
  tier2Count      Int      @default(0)
  tier3Count      Int      @default(0)
  hasConflicts    Boolean  @default(false)
  velocity30m     Int      @default(0)
  velocityPrev30m Int      @default(0)
  acceleration    Float    @default(1.0)
  trend           String   @default("STABLE")
  consistency     Float    @default(1.0)
  dis             Int      @default(0)
  peakDis         Int      @default(0)
  peakAt          DateTime?
  firstSeen       DateTime
  latestItem      DateTime
  siteId          String?
  newsItems       String[]
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  summary         ClusterSummary?

  @@index([dis])
  @@index([eventType])
  @@index([trend])
  @@index([primaryEntity])
}

model ClusterSummary {
  id                 String       @id @default(cuid())
  clusterId          String       @unique
  cluster            StoryCluster @relation(fields: [clusterId], references: [id], onDelete: Cascade)
  mainClaims         Json
  conflictingReports Json?
  signalIntegrity    Json
  summaryText        String       @db.Text
  confidence         String       @default("MEDIUM")
  generatedAt        DateTime     @default(now())
}

model MatchResult {
  id            String   @id @default(cuid())
  apiFootballId Int?     @unique
  homeTeam      String
  awayTeam      String
  homeScore     Int?
  awayScore     Int?
  league        String?
  season        String?
  matchDate     DateTime
  status        String?
  events        Json?
  lastUpdated   DateTime @default(now())

  @@index([matchDate])
  @@index([homeTeam, awayTeam])
}

model AutopilotConfig {
  id              String   @id @default(cuid())
  orgId           String   @unique

  dailyTarget     Int      @default(10)
  defaultLength   Int      @default(800)
  scheduleStart   String   @default("08:00")
  scheduleEnd     String   @default("00:00")
  is24h           Boolean  @default(false)

  autoPublish     Boolean  @default(true)
  matchAutoCoverage Boolean @default(true)
  liveArticles    Boolean  @default(true)
  breakingNews    Boolean  @default(true)
  breakingThreshold Int    @default(70)
  gapDetection    Boolean  @default(true)
  gapHours        Int      @default(2)

  contentStyle    String   @default("signal_only")
  translateLang   String   @default("bs")
  translateLanguages String[] @default(["bs"])
  alwaysCreditSources Boolean @default(true)
  linkOriginal    Boolean  @default(true)
  addSourceTag    Boolean  @default(true)
  tone            String   @default("neutral")

  isActive        Boolean  @default(true)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  categories      AutopilotCategory[]
  leagues         AutopilotLeague[]
  topics          AutopilotTopic[]
  channels        DistributionChannel[]
}

model AutopilotCategory {
  id              String   @id @default(cuid())
  configId        String
  config          AutopilotConfig @relation(fields: [configId], references: [id], onDelete: Cascade)

  name            String
  slug            String
  color           String
  percentage      Int      @default(10)

  widgetPoll      Boolean  @default(false)
  widgetQuiz      Boolean  @default(false)
  widgetStats     Boolean  @default(false)
  widgetPlayer    Boolean  @default(false)
  widgetVideo     Boolean  @default(false)
  widgetGallery   Boolean  @default(false)

  sortOrder       Int      @default(0)

  @@unique([configId, slug])
  @@index([configId])
}

model AutopilotLeague {
  id              String   @id @default(cuid())
  configId        String
  config          AutopilotConfig @relation(fields: [configId], references: [id], onDelete: Cascade)

  name            String
  apiFootballId   Int?
  flag            String?
  weight          Int      @default(10)
  isActive        Boolean  @default(true)

  @@unique([configId, apiFootballId])
  @@index([configId])
}

model AutopilotTopic {
  id              String   @id @default(cuid())
  configId        String
  config          AutopilotConfig @relation(fields: [configId], references: [id], onDelete: Cascade)

  name            String
  icon            String?
  keywords        String[]
  isActive        Boolean  @default(true)

  createdAt       DateTime @default(now())

  @@index([configId])
}

model DistributionChannel {
  id              String   @id @default(cuid())
  configId        String
  config          AutopilotConfig @relation(fields: [configId], references: [id], onDelete: Cascade)

  platform        String
  accountName     String
  accountId       String?
  followers       String?
  filter          String   @default("all")
  isActive        Boolean  @default(true)

  @@index([configId])
}
